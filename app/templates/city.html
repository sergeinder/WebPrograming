<!doctype html>
<html lang="en">
<head>
    <script src="https://api-maps.yandex.ru/2.0-stable/?apikey=9a9e76e0-a2b2-4150-a38d-30b776ddd95e&load=package.standard&lang=ru-RU" type="text/javascript"></script>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel ="stylesheet" href="{{ url_for('static', path='/css/header_block.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/citynum.css') }}">
    <style>
        html, body, #map {
            width: 100%; height: 100%; padding: 0; margin: 0;
        }
    </style>
    <title>Moscow</title>
</head>
<body>
    <header>
    <div class="menu">
      <a href="http://localhost:8000/pages/main" id="home">Home</a>
    </div>
    <div class="account" id="menuright">
    </div>
    </header> 
    <script src="{{url_for('static',path='js/header.js')}}" type="text/javascript"></script>
    
    <div class="name">
      <div id="like"></div>
      <h6>{{city.name}}</h6>
      <button type="button" id="favorite" class="active">Favorite</button>
    </div>
    <img class="panorama" src="{{url_for('static',path='images/'+city.big_photo_id|string+'.jpg')}}">

    <div id="json-data"></div>

    <script>
      function fetchData_attractions() {
      return fetch('http://localhost:8000/attractions?city_id={{city.id}}', {post: 'GET',})
      .then((response) => response.json())
      .then(data => {
        createList_attractions(data);
      })
      .catch((e) => {
      console.log(e)
      })}

      function createList_attractions(data) {
        const preElement = document.getElementById('json-data');
        ymaps.ready(function () {
        var myMap = new ymaps.Map('map', {
            center: ['{{city.longitude}}', '{{city.latitude}}'],
            zoom: 12
        });
        for (let i = 0; i < data.length; i++) {
        var Placemark = new ymaps.Placemark([data[i].longitude, data[i].latitude],{iconContent: data[i].name},{preset: 'twirl#blueStretchyIcon'});
        myMap.geoObjects.add(Placemark);
        }
        myMap.controls.add('zoomControl');
        myMap.controls.add('typeSelector');
        });
        for (let i = 0; i < data.length; i++) {
          var card = document.createElement('div')
          card.setAttribute('class', 'card');
          preElement.appendChild(card);
          var img = document.createElement('img')
          var str  = "{{url_for('static',path='images/')}}"
          img.setAttribute('src', str + data[i].image_id+ '.jpg');
          card.appendChild(img);
          var card__text = document.createElement('div')
          card__text.setAttribute('class', 'card__text');
          card.appendChild(card__text);
          var h4 = document.createElement('h4')
          h4.innerText = data[i].name;
          card__text.appendChild(h4);
          var addres = document.createElement('h3')
          addres.setAttribute('class', 'addres');
          addres.innerText = 'Addres: ' + data[i].address;
          card__text.appendChild(addres);
          var p = document.createElement('p')
          p.innerText = data[i].description;
          card__text.appendChild(p);
      }
    }
      fetchData_attractions()
    </script>


    <div id="map"></div>
</body>
</html>

<script>
  const Like = document.getElementById('like');
  var ws = new WebSocket(`ws://localhost:8000/cities/ws/{{city.id}}`);
  const buttonf = document.getElementById('favorite');
  buttonf.addEventListener('click', async function(){
      const url = "http://localhost:8000/favourites?city_id={{city.id}}";
      let response1 = await  fetch(url, {method: 'POST',
                headers: {'Content-Type': 'application/json'}, 
                credentials: 'include',}
      )
      if (!response1.ok) {
        window.location.href = "/pages/login"
      }else{
        ws.send('1')
      }
    } )
    ws.onmessage = function(event) {
    Like.innerText = event.data;
    };
</script>